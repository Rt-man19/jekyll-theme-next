**Kafka是一个开源的分布式的消息引擎系统**，根据维基百科的定义,消息引擎系统是一组规范,企业可以利用这组规范在不同系统之间传递语义准确的消息实现松耦合的异步式数据传递。

通俗一点说，就是: 系统A发送消息给消息引擎系统，系统B从消息引擎系统中读取A发来的消息。这是最基础的消息引擎所做的事。

通过上面的说明，可以了解到两个重要的东西:

- 消息引擎系统传输的对象是消息
- 如何传递消息属于消息引擎设计机制的一种

### 消息设计

既然消息引擎是用于在不同系统之间传输消息的，试想，一条消息如何做到准确表达业务而无歧义?同时还需要最大限度的提供可重用性及通用性?所以设计消息的格式从来都是头等大事

Kafka的消息设计是: 使用纯二进制的字节序列。消息还是结构化的，只是在使用之前都要转成二进制的字节序列。

### 消息传输方式

消息设计之后，还要有具体的传输协议，常见的有两种方法:

- 点对点模型： 也叫消息队列模型。即系统A发送的消息只能被系统B接收，其他系统都无法读取A发送的消息。
- 发布/订阅模型:  与上面的不同,它有一个主题(topic)的概念。该模型也有接收方和发送方，发送方称为发布者，接收方称为订阅者。这个模型可能存在多个发布者向相同的主题发送消息，而订阅者也可以存在多个，它们都能接收到相同主题的消息。

Kafka这两种方法都支持的呦



### Kafka术语

前面提到过Kafka是一个**开源的分布式的消息引擎系统**，它的主要功能就是提供完整的消息发布/订阅的解决方案。

##### Topic&Producer&Consumer

在Kafka中发布订阅的对象是Topic，可以为每个业务、每个应用都创建专属的Topic。可以把Topic理解为逻辑语义相近的消息的一个容器。

向Topic发布消息的客户端称为Producer(生产者)，Producer通常储蓄不断的向一个或多个Topic发送消息。而订阅这些主题的客户端则称为Comsumer(消费者)。Comsumer也可以同时订阅多个Topic的消息。

##### Broker

Kafka的服务器端是Broker的服务进程，一个Kafka集群由多个Broker组成,Broker负责接收和处理客户端发送来的请求,以及对消息进行持久化。多个Broker是可以运行在同一台机器中的，但是不建议这么做，一般都是把不同的Broker分散在不同的机器中。这样集群中一台机器宕机，其他机器上的Broker也可以对外提供服务,这也是Kafka的高可用实现方式之一。

##### Replication

实现高可用的另一种方式就是**Replication(副本机制)**，它就是把相同的数据拷贝到多台机器中。Kafka定义了两中类型的副本:

- **领导者副本(Leader Replica)**
- **追随者副本(Follower Replica)**

领导者副本对外提供服务，也就是和客户端进行交互。追随者副本不能对外提供服务，只是单纯的追随领导者副本。

**副本的工作机制:**

1. 生产者向领导者副本写消息
2. 消费者总是从领导者副本中读取消息
3. 追随者副本只负责向领导者发送请求，请求领导者把最新的消息发送给他。

除了上面这些，Kafka还有分区(Partition)的概念。分区的作用是吧Topic中的数据分割成多份保存到不同的Broker上。这样可以解决领导者副本堆积太多的数据以至于单台Broker无法容纳的问题。



##### Partition&Offset

它是把每个Topic划分成多个Partition，每个Partition是一组有序的消息日志,生产者生产的每条消息只会被发送到一个分区中。这也就意味着，生产者向有两个Partition的Topic发送数据时，消息要么发送到分区0,要么发送到分区1中。**注意: Kafka的分区编号是从0开始的**

并且上面提到的副本机制是在分区这一层定义的,每个分区下可以配置N个副本,其中只能有1个领导者副本和N-1个追随者副本。Producer向分区写入消息，每条消息在分区中的位置信息由Offset(偏移量)来表示，Offset是从0开始，假设一个生产者向一个空分区写入了10条消息，那么这10 条消息的Offset分别是0、1...9。



**主题、分区、副本的关系**

- 每个主题可以配置N个分区，每个分区又可以配置X个副本
- ·每个分区的X个副本只能有一个副本作为领导者副本，X-1副本是追随者副本，提供数据冗余
- 每个分区中包含若干条消息，每条消息的Offset从0 开始，依次递增。
- 客户端只能与分区的领导者副本进行交互。



##### Comsumer Group

前面提到过消息传输的两种方式,其中点对点方式，指的是同一条消息只能被下游的一个消费者消费。在Kafka中实现这种消息传输模型的方法，就是引入了消费组(Comsumer Group)

消费组,顾名思义，指的是多个消费者组成一个组来消费一组主题，这组主题中的每个分区只能被组内的一个消费者消费。



最后总结一下:



- 消息：Record。Kafka 是消息引擎嘛，这里的消息就是指 Kafka 处理的主要对象。
- 主题：Topic。主题是承载消息的逻辑容器，在实际使用中多用来区分具体的业务。
- 分区：Partition。一个有序不变的消息序列。每个主题下可以有多个分区。
- 消息位移：Offset。表示分区中每条消息的位置信息，是一个单调递增且不变的值。
- 副本：Replica。Kafka 中同一条消息能够被拷贝到多个地方以提供数据冗余，这些地方就是所谓的副本。副本还分为领导者副本和追随者副本，各自有不同的角色划分。副本是在分区层级下的，即每个分区可配置多个副本实现高可用。
- 生产者：Producer。向主题发布新消息的应用程序。
- 消费者：Consumer。从主题订阅新消息的应用程序。
- 消费者位移：Consumer Offset。表征消费者消费进度，每个消费者都有自己的消费者位移。
- 消费者组：Consumer Group。多个消费者实例共同组成的一个组，同时消费多个分区以实现高吞吐。
  

极客时间版权所有: https://time.geekbang.org/column/article/99318